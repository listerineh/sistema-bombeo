name: Build All Platforms

on:
  workflow_dispatch:
    inputs:
      create_tag:
        description: 'Create a new tag and release'
        required: false
        default: 'false'
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: false
        default: '1.0.0'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6==6.10.2
        pip install PyInstaller==6.18.0
    
    - name: Build Windows executable
      run: |
        pyinstaller --onedir --windowed --add-data "src/data;data" --name=SistemaBombeo main.py
    
    - name: Create Windows ZIP
      run: |
        mkdir windows-package
        xcopy /E /I dist\SistemaBombeo windows-package\SistemaBombeo
        xcopy /E /I src\data windows-package\SistemaBombeo\data
        cd windows-package
        7z a -tzip ../SistemaBombeo-v${{ github.event.inputs.version }}-Windows.zip *
        cd ..
    
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows
        path: SistemaBombeo-v${{ github.event.inputs.version }}-Windows.zip
        retention-days: 30

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyQt6==6.10.2
        pip install PyInstaller==6.18.0
    
    - name: Build macOS executable
      run: |
        # Use system Python and exclude PyQt6 from bundle
        export PYTHONNOUSERSITE=1
        export MACOSX_DEPLOYMENT_TARGET=10.14
        pyinstaller --onedir --windowed --add-data "src/data:data" --name=SistemaBombeo --noupx --exclude-module PyQt6 --exclude-module tkinter --exclude-module matplotlib --exclude-module PIL --exclude-module numpy --exclude-module scipy --exclude-module pandas --strip main.py
    
    - name: Create macOS ZIP
      run: |
        mkdir macos-package
        cp -r dist/SistemaBombeo macos-package/
        cp -r src/data macos-package/SistemaBombeo/
        cd macos-package
        zip -r ../SistemaBombeo-v${{ github.event.inputs.version }}-macos.zip *
        cd ..
    
    - name: Upload macOS artifact
      uses: actions/upload-artifact@v4
      with:
        name: macos
        path: SistemaBombeo-v${{ github.event.inputs.version }}-macos.zip
        retention-days: 30

  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pyqt6 python3-dev
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install PyInstaller==6.18.0
    
    - name: Build Linux executable
      run: |
        pyinstaller --onedir --windowed --add-data "src/data:data" --name=SistemaBombeo main.py
    
    - name: Create Linux ZIP
      run: |
        mkdir linux-package
        cp -r dist/SistemaBombeo linux-package/
        cp -r src/data linux-package/SistemaBombeo/
        cd linux-package
        zip -r ../SistemaBombeo-v${{ github.event.inputs.version }}-Linux.zip *
        cd ..
    
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v4
      with:
        name: linux
        path: SistemaBombeo-v${{ github.event.inputs.version }}-Linux.zip
        retention-days: 30

  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: github.event.inputs.create_tag == 'true'
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Install GitHub CLI
      run: |
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        sudo apt update
        sudo apt install gh
    
    - name: Create tag and release with GitHub CLI
      run: |
        VERSION="${{ github.event.inputs.version }}"
        echo "Creating tag v$VERSION first..."
        gh release create "v$VERSION" \
          --title "Release v$VERSION" \
          --notes "Release v$VERSION" \
          --latest \
          --generate-notes \
          windows/SistemaBombeo-v${{ github.event.inputs.version }}-Windows.zip \
          macos/SistemaBombeo-v${{ github.event.inputs.version }}-macos.zip \
          linux/SistemaBombeo-v${{ github.event.inputs.version }}-Linux.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
